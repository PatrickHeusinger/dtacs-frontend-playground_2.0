---
name: Generate SBOM
on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  generate-sbom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy in GitHub SBOM mode and submit results to Dependency Graph
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          format: 'github'
          output: 'dependency-results.sbom.json'
          scan-ref: '.'
          github-pat: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload SBOM to Dependency-Track
        run: |
          curl -L -vX POST https://dtrack.datatactics.dev/api/v1/bom \
            -H 'Content-Type: multipart/form-data' \
            -H "X-API-Key: odt_531QuhvvwhYG6cywF2MtzNhNJ5o4oTQR" \
            -F "autoCreate=true" \
            -F "projectName=${IMAGE}" \
            -F "projectVersion=${TAG}" \
            -F "parentUUID=${PARENTUUID}" \
            -F "bom=@dependency-results.sbom.json"
        env:
          IMAGE: 'github.com/datatactics/playground'
          TAG: 'main'
          PARENTUUID: "484f553b-1a01-41f2-922f-96af4e8b73c2"
